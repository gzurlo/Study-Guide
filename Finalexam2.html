<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Study Buddy – Major Concepts Review (Physics, Earth Sci, Astronomy)</title>
    <style>
      :root { color-scheme: dark; }

      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
        background: #020617;
        color: #e5e7eb;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        min-height: 100vh;
        margin: 0;
        padding: 24px;
      }

      h1 { margin-top: 8px; margin-bottom: 4px; font-size: 1.9rem; text-align: center; }
      p.subtitle { margin-top: 0; margin-bottom: 10px; color: #9ca3af; text-align: center; font-size: 0.95rem; }

      .app-shell { width: 100%; max-width: 860px; }
      .top-row {
        display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
        gap: 8px; margin-bottom: 8px;
      }
      .deck-label { font-size: 0.85rem; color: #9ca3af; }
      .pill {
        display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px;
        border-radius: 999px; border: 1px solid #1f2937; background: #020617;
        font-size: 0.8rem; color: #9ca3af;
      }
      .pill strong { color: #e5e7eb; }

      .mode-switch {
        display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; justify-content: center;
      }
      .mode-button {
        border-radius: 999px; border: 1px solid #374151; padding: 6px 14px; font-size: 0.85rem;
        cursor: pointer; background: #0b1120; color: #e5e7eb;
        transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.1s ease, border-color 0.1s ease;
      }
      .mode-button.mode-active {
        background: #4f46e5; border-color: #6366f1; box-shadow: 0 8px 24px rgba(79, 70, 229, 0.35);
      }
      .mode-button:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(0,0,0,0.45); }

      .filter-row {
        display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin-bottom: 6px;
      }
      .filter-button {
        border-radius: 999px; border: 1px solid #374151; padding: 4px 10px; font-size: 0.78rem;
        cursor: pointer; background: #020617; color: #9ca3af; transition: background 0.15s ease, border-color 0.1s ease;
      }
      .filter-button.filter-active { background: #0369a1; color: #e5e7eb; border-color: #0ea5e9; }
      .filter-note { text-align: center; font-size: 0.78rem; color: #6b7280; margin-bottom: 6px; }

      .mode { width: 100%; }
      .hidden { display: none; }

      .card, .quiz-card {
        background: #020617; border-radius: 18px; box-shadow: 0 18px 40px rgba(0,0,0,0.55);
        border: 1px solid #1f2937; margin: 16px auto; max-width: 640px;
      }
      .card {
        padding: 24px 28px; cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
      }
      .card:hover { transform: translateY(-2px); box-shadow: 0 22px 50px rgba(0,0,0,0.6); background: #02041b; }
      .quiz-card { padding: 22px 24px; }

      .card-label {
        text-transform: uppercase; letter-spacing: 0.12em; font-size: 0.7rem; color: #6366f1; margin-bottom: 6px;
      }
      .card-content { font-size: 1.1rem; line-height: 1.5; white-space: pre-wrap; }
      .card-hint { margin-top: 8px; font-size: 0.8rem; color: #6b7280; }

      .controls {
        display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 6px; margin-bottom: 10px;
      }
      button {
        border-radius: 999px; border: 1px solid #374151; padding: 8px 16px; font-size: 0.9rem; cursor: pointer;
        background: #111827; color: #e5e7eb;
        transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.1s ease;
      }
      button.primary { background: #4f46e5; border-color: #6366f1; }
      button.good { background: #16a34a; border-color: #22c55e; }
      button.bad { background: #b91c1c; border-color: #ef4444; }
      button.subtle { background: #020617; border-color: #1f2937; font-size: 0.8rem; padding: 5px 12px; }
      button:hover { transform: translateY(-1px); box-shadow: 0 8px 18px rgba(0,0,0,0.4); }
      button:active { transform: translateY(0); box-shadow: none; }

      .stats { margin-top: 6px; font-size: 0.85rem; color: #9ca3af; text-align: center; }
      .stats span { margin: 0 6px; }

      .tagline { margin-top: 18px; font-size: 0.78rem; color: #6b7280; text-align: center; }
      .tagline kbd {
        background: #020617; border-radius: 4px; padding: 1px 4px; border: 1px solid #1f2937; font-size: 0.7rem;
      }

      /* Matching */
      .matching-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 0.9rem; }
      .matching-term {
        flex: 0 0 38%; padding: 6px 10px; background: #020617; border-radius: 10px; border: 1px solid #111827;
      }
      .matching-select {
        flex: 1; padding: 6px 8px; border-radius: 999px; border: 1px solid #374151;
        background: #020617; color: #e5e7eb; font-size: 0.85rem;
      }
      .matching-select.correct { border-color: #22c55e; box-shadow: 0 0 0 1px #22c55e; }
      .matching-select.incorrect { border-color: #ef4444; box-shadow: 0 0 0 1px #ef4444; }

      /* Quiz */
      .quiz-settings {
        background: #0b1120; border-radius: 12px; padding: 12px 16px; margin-bottom: 12px;
        border: 1px solid #1f2937;
      }
      .settings-row {
        display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 8px;
      }
      .settings-row:last-child { margin-bottom: 0; }
      .setting-label {
        font-size: 0.85rem; color: #e5e7eb; display: flex; align-items: center; gap: 6px;
      }
      .setting-label input[type="checkbox"] {
        width: 16px; height: 16px; cursor: pointer;
      }
      .setting-label select {
        margin-left: 6px; padding: 4px 8px; border-radius: 6px; border: 1px solid #374151;
        background: #020617; color: #e5e7eb; font-size: 0.85rem;
      }

      .quiz-header {
        display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;
      }
      .quiz-question-label {
        text-transform: uppercase; letter-spacing: 0.12em; font-size: 0.7rem; color: #f97316;
      }
      .quiz-timer {
        font-size: 1.1rem; font-weight: bold; padding: 4px 12px; border-radius: 999px;
        background: #0b1120; border: 1px solid #374151;
      }
      .quiz-timer.warning { color: #f97316; border-color: #f97316; }
      .quiz-timer.danger { color: #ef4444; border-color: #ef4444; animation: pulse 0.5s infinite; }
      @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

      .quiz-progress-bar {
        width: 100%; height: 4px; background: #1f2937; border-radius: 2px; margin-bottom: 12px;
        overflow: hidden;
      }
      .quiz-progress-fill {
        height: 100%; background: linear-gradient(90deg, #4f46e5, #6366f1); width: 0%;
        transition: width 0.3s ease;
      }

      .quiz-question-text { font-size: 1.05rem; line-height: 1.5; margin-bottom: 16px; font-weight: 500; }
      .quiz-options { display: flex; flex-direction: column; gap: 10px; }
      .quiz-option {
        text-align: left; width: 100%; padding: 12px 16px; font-size: 0.95rem;
        transition: all 0.2s ease;
      }
      .quiz-option:hover:not(:disabled) { background: #1f2937; transform: translateX(4px); }
      .quiz-option.correct { background: #14532d; border-color: #22c55e; }
      .quiz-option.incorrect { background: #7f1d1d; border-color: #ef4444; }
      .quiz-option:disabled { cursor: not-allowed; }

      .quiz-feedback { margin-top: 12px; font-size: 0.95rem; font-weight: 500; }
      .quiz-feedback.correct { color: #4ade80; }
      .quiz-feedback.incorrect { color: #fca5a5; }

      .quiz-explanation {
        margin-top: 10px; padding: 12px; background: #0b1120; border-radius: 8px;
        border-left: 3px solid #6366f1; font-size: 0.9rem; line-height: 1.5;
        color: #d1d5db; display: none;
      }
      .quiz-explanation.show { display: block; }

      .quiz-summary {
        margin-top: 12px; padding: 16px; background: #0b1120; border-radius: 12px;
        border: 1px solid #1f2937; display: none;
      }
      .quiz-summary.show { display: block; }
      .quiz-summary h3 {
        margin: 0 0 12px 0; color: #f97316; font-size: 1.1rem;
      }
      .quiz-summary-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;
      }
      .quiz-summary-stat {
        text-align: center; padding: 12px; background: #020617; border-radius: 8px;
      }
      .quiz-summary-stat-value {
        font-size: 1.8rem; font-weight: bold; color: #6366f1;
      }
      .quiz-summary-stat-label {
        font-size: 0.8rem; color: #9ca3af; margin-top: 4px;
      }

      @media (max-width: 600px) {
        body { padding: 16px; }
        .card, .quiz-card { padding: 18px 20px; }
      }
    </style>
  </head>
  <body>
    <h1>Study Buddy – Major Concepts Review</h1>
    <p class="subtitle">Physics • Earth Science • Astronomy</p>

    <div class="app-shell">
      <div class="top-row">
        <div class="deck-label">Deck: <strong>Major Concepts – Final Review</strong></div>
        <div class="pill">Cards in deck: <strong id="deck-count">0</strong></div>
      </div>

      <!-- MODE SWITCH -->
      <div class="mode-switch">
        <button class="mode-button mode-active" data-mode="flashcards">Flashcards</button>
        <button class="mode-button" data-mode="matching">Matching</button>
        <button class="mode-button" data-mode="quiz">Quiz</button>
      </div>

      <!-- FILTERS -->
      <div class="filter-row">
        <button class="filter-button filter-active" data-filter="all">All cards</button>
        <button class="filter-button" data-filter="unknown">Only "Not yet"</button>
        <button class="filter-button" data-filter="known">Only "Got it"</button>
      </div>

      <!-- DIFFICULTY FILTERS -->
      <div class="filter-row">
        <button class="filter-button filter-active" data-difficulty="all">All difficulty</button>
        <button class="filter-button" data-difficulty="easy">Easy</button>
        <button class="filter-button" data-difficulty="medium">Medium</button>
        <button class="filter-button" data-difficulty="hard">Hard</button>
      </div>
      <div class="filter-note">Filters apply to <strong>all modes</strong>. Progress is saved automatically on this device.</div>

      <!-- FLASHCARDS MODE -->
      <div id="mode-flashcards" class="mode">
        <div id="flashcard" class="card">
          <div class="card-label" id="card-label">Term</div>
          <div class="card-content" id="card-content"></div>
          <div class="card-hint" id="card-hint">Click card or press <kbd>Space</kbd> to flip.</div>
        </div>

        <div class="controls">
          <button id="prev">◀ Prev</button>
          <button id="flip" class="primary">Flip</button>
          <button id="next">Next ▶</button>
          <button id="shuffle">Shuffle</button>
        </div>

        <div class="controls">
          <button id="know" class="good">Got it ✅</button>
          <button id="dontKnow" class="bad">Not yet ❌</button>
          <button id="reset" class="subtle">Reset flashcard stats</button>
        </div>

        <div class="stats" id="stats"></div>
      </div>

      <!-- MATCHING MODE -->
      <div id="mode-matching" class="mode hidden">
        <p class="subtitle">
          Match each <strong>term</strong> on the left with the correct <strong>definition</strong> on the right.
        </p>
        <div id="matching-container"></div>
        <div class="controls">
          <button id="matching-new" class="primary">New round</button>
          <button id="matching-check">Check answers</button>
        </div>
        <div class="stats" id="matching-result"></div>
      </div>

      <!-- QUIZ MODE -->
      <div id="mode-quiz" class="mode hidden">
        <p class="subtitle">Multiple-choice: pick the correct <strong>term</strong> for each definition.</p>

        <!-- Quiz Settings -->
        <div class="quiz-settings">
          <div class="settings-row">
            <label class="setting-label">
              <input type="checkbox" id="quiz-app-only" />
              Application questions only (harder)
            </label>
            <label class="setting-label">
              <input type="checkbox" id="quiz-timer" />
              Timed mode (30s per question)
            </label>
          </div>
          <div class="settings-row">
            <label class="setting-label">
              Difficulty:
              <select id="quiz-difficulty-select">
                <option value="all">All difficulties</option>
                <option value="easy">Easy only</option>
                <option value="medium">Medium only</option>
                <option value="hard">Hard only</option>
                <option value="progressive">Progressive (easy→hard)</option>
              </select>
            </label>
            <label class="setting-label">
              Question count:
              <select id="quiz-question-count">
                <option value="10">10 questions</option>
                <option value="20">20 questions</option>
                <option value="30">30 questions</option>
                <option value="50">50 questions</option>
                <option value="all">All questions</option>
              </select>
            </label>
          </div>
        </div>

        <div class="quiz-card">
          <div class="quiz-header">
            <div class="quiz-question-label" id="quiz-round-label">Question</div>
            <div class="quiz-timer" id="quiz-timer-display"></div>
          </div>
          <div class="quiz-progress-bar">
            <div class="quiz-progress-fill" id="quiz-progress-fill"></div>
          </div>
          <div class="quiz-question-text" id="quiz-question"></div>
          <div class="quiz-options" id="quiz-options"></div>
          <div class="quiz-feedback" id="quiz-feedback"></div>
          <div class="quiz-explanation" id="quiz-explanation"></div>
        </div>

        <div class="controls">
          <button id="quiz-next" class="primary">Next question</button>
          <button id="quiz-retry" class="subtle">Retry missed questions</button>
          <button id="quiz-reset" class="subtle">Reset quiz stats</button>
          <button id="quiz-new-session" class="subtle">New quiz session</button>
        </div>
        <div class="stats" id="quiz-stats"></div>
        <div class="quiz-summary" id="quiz-summary"></div>
      </div>

      <p class="tagline">
        Flashcards shortcuts: <kbd>←</kbd>/<kbd>→</kbd> prev/next, <kbd>Space</kbd> flip, <kbd>1</kbd> Got it, <kbd>2</kbd> Not yet.
      </p>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        (function () {
          const flashcards = [
            // PHYSICS: NEWTON'S LAWS (with different difficulty levels)
            { id: 1, term: "Newton’s First Law (Inertia)", definition: "An object at rest stays at rest and an object in motion stays in motion unless acted on by a net external force.", difficulty: "easy" },
            { id: 2, term: "Newton’s Second Law (Acceleration)", definition: "Net force causes acceleration: F = m·a. More force → more acceleration; more mass → less acceleration.", difficulty: "medium" },
            { id: 3, term: "Newton’s Third Law (Action–Reaction)", definition: "For every action force, there is an equal and opposite reaction force.", difficulty: "easy" },
            { id: 4, term: "Impulse", definition: "Impulse = Force × Time; changes momentum.", difficulty: "medium" },
            { id: 5, term: "Momentum", definition: "Momentum = mass × velocity. Describes how hard an object is to stop.", difficulty: "easy" },
            { id: 6, term: "Work", definition: "Work = Force × Distance. Work is done when a force causes displacement.", difficulty: "medium" },
            { id: 7, term: "Power", definition: "Power = Work / Time. Power is the rate of doing work.", difficulty: "medium" },
            { id: 8, term: "Kinetic Energy", definition: "Energy of motion, commonly KE = 1/2 m v².", difficulty: "medium" },
            { id: 9, term: "Potential Energy", definition: "Stored energy due to position or condition, such as gravitational potential energy.", difficulty: "medium" },
            { id: 10, term: "Universal Law of Gravitation", definition: "All masses attract each other; force depends on masses and distance: F ∝ m1·m2 / r².", difficulty: "hard" },
            { id: 11, term: "Inverse Square Law", definition: "Gravitational force decreases with the square of the distance: doubling r makes force 1/4 as strong.", difficulty: "hard" },

            // EARTH SCIENCE: OCEANS
            { id: 12, term: "Salinity", definition: "Amount of dissolved salts in seawater; affects density and circulation.", difficulty: "easy" },
            { id: 13, term: "Ocean Tides", definition: "Daily sea-level changes mainly caused by the Moon’s gravity, with the Sun also contributing.", difficulty: "easy" },

            // EARTH SCIENCE: ATMOSPHERE
            { id: 14, term: "Layers of the Atmosphere", definition: "Troposphere, stratosphere, mesosphere, thermosphere, exosphere (ordered from ground up).", difficulty: "medium" },
            { id: 15, term: "Solar Radiation", definition: "Incoming energy from the Sun, shorter wavelength, heats Earth.", difficulty: "medium" },
            { id: 16, term: "Terrestrial Radiation", definition: "Energy Earth re-emits back to space, longer wavelength (infrared).", difficulty: "medium" },
            { id: 17, term: "Seasons", definition: "Caused by Earth’s 23.5° axial tilt and revolution around the Sun, changing sunlight angle and day length.", difficulty: "easy" },
            { id: 18, term: "Convection Cycle", definition: "Warm, less-dense air rises; cool, denser air sinks, creating circulation in atmosphere/oceans.", difficulty: "medium" },

            // EARTH SCIENCE: WEATHER & CLIMATE
            { id: 19, term: "Weather", definition: "Day-to-day state of the atmosphere (temperature, precipitation, wind, etc.).", difficulty: "easy" },
            { id: 20, term: "Climate", definition: "Average weather conditions over 30+ years for a region.", difficulty: "medium" },
            { id: 21, term: "Climate Change", definition: "Long-term shift in climate patterns; driven by natural and human causes, with modern influence from greenhouse gases.", difficulty: "hard" },
            { id: 22, term: "Sea Level Rise", definition: "Increase in global sea level due to melting ice and thermal expansion of warming water.", difficulty: "hard" },
            { id: 23, term: "Humidity", definition: "Amount of water vapor in the air.", difficulty: "easy" },
            { id: 24, term: "Dew Point", definition: "Temperature at which air becomes saturated and condensation begins.", difficulty: "medium" },
            { id: 25, term: "Lifting Mechanisms for Clouds", definition: "Four ways air rises to form clouds: orographic (mountain), frontal (weather fronts), convergence (air masses meet), convective (surface heating).", difficulty: "hard" },
            { id: 26, term: "Thunderstorms", definition: "Severe storms with lightning, thunder, heavy rain, and sometimes hail; caused by strong updrafts in unstable air.", difficulty: "medium" },
            { id: 27, term: "Tornadoes", definition: "Violent rotating columns of air extending from thunderstorms to ground; form in supercells with wind shear.", difficulty: "medium" },
            { id: 28, term: "Hurricanes", definition: "Large rotating tropical storms with sustained winds ≥74 mph; form over warm ocean water, powered by evaporation and condensation.", difficulty: "hard" },

            // ASTRONOMY: SOLAR SYSTEM
            { id: 29, term: "Nebular Theory", definition: "Solar system formed from a rotating cloud of gas/dust that collapsed, flattened, and formed the Sun and planets.", difficulty: "easy" },
            { id: 30, term: "Inner Planets", definition: "Mercury, Venus, Earth, Mars: small, rocky, dense, closer to the Sun, shorter orbital periods.", difficulty: "medium" },
            { id: 31, term: "Outer Planets", definition: "Jupiter, Saturn, Uranus, Neptune: large, gas/ice giants, less dense, farther from the Sun, longer orbital periods.", difficulty: "medium" },
            { id: 32, term: "Pluto Characteristics", definition: "Small dwarf planet with elliptical orbit that crosses Neptune's; cleared only part of its orbital path, so it was reclassified from planet to dwarf planet in 2006.", difficulty: "hard" },
            { id: 33, term: "Comets", definition: "Icy bodies that orbit the Sun, developing tails when near the Sun.", difficulty: "easy" },
            { id: 34, term: "Asteroids", definition: "Rocky/metallic objects orbiting the Sun, mostly in the asteroid belt.", difficulty: "medium" },
            { id: 35, term: "Meteoroid", definition: "Small rocky or metallic object in space, smaller than an asteroid.", difficulty: "easy" },
            { id: 36, term: "Meteor", definition: "A meteoroid that burns up as it enters Earth's atmosphere, creating a streak of light (shooting star).", difficulty: "easy" },
            { id: 37, term: "Meteorite", definition: "A meteoroid that survives passage through the atmosphere and lands on Earth's surface.", difficulty: "medium" },

            // ASTRONOMY: EARTH'S MOON
            { id: 38, term: "Moon Phases", definition: "Changing appearance of the Moon as it orbits Earth: new, waxing crescent, first quarter, waxing gibbous, full, waning gibbous, last quarter, waning crescent.", difficulty: "medium" },
            { id: 39, term: "Solar Eclipse", definition: "Moon passes between Earth and Sun, blocking sunlight; only visible in narrow path on Earth (Moon's shadow on Earth).", difficulty: "medium" },
            { id: 40, term: "Lunar Eclipse", definition: "Earth passes between Sun and Moon, Earth's shadow falls on the Moon; visible from entire night side of Earth.", difficulty: "medium" },

            // ASTRONOMY: NIGHT SKY
            { id: 41, term: "Constellations", definition: "Patterns of stars in the sky; appear to change position throughout the year due to Earth's revolution around the Sun.", difficulty: "medium" },
            { id: 42, term: "Polaris (North Star)", definition: "Star aligned with Earth's rotation axis; appears stationary in the northern sky while other stars appear to rotate around it.", difficulty: "easy" },

            // ASTRONOMY: STARS
            { id: 43, term: "Star Life Cycle", definition: "Nebula → protostar → main sequence → (low mass: red giant → planetary nebula → white dwarf) OR (high mass: supergiant → supernova → neutron star/black hole).", difficulty: "hard" },
            { id: 44, term: "Planetary Nebula", definition: "Shell of gas ejected by a low/medium mass star at the end of its life; glowing remnant surrounding a white dwarf.", difficulty: "medium" },
            { id: 45, term: "Supernova", definition: "Explosive death of a massive star creating heavy elements and a stellar remnant.", difficulty: "medium" },
            { id: 46, term: "Apparent Brightness", definition: "How bright a star appears from Earth; depends on both luminosity and distance.", difficulty: "medium" },
            { id: 47, term: "Luminosity", definition: "Actual energy/light output of a star per second; intrinsic brightness independent of distance.", difficulty: "medium" },
            { id: 48, term: "Star Color", definition: "Indicates temperature: blue/white stars are hottest, yellow medium, red coolest.", difficulty: "easy" },
            { id: 49, term: "H–R Diagram", definition: "Plot of luminosity vs temperature; shows main sequence, giants/supergiants, and white dwarfs.", difficulty: "hard" },

            // ASTRONOMY: BLACK HOLES
            { id: 50, term: "Black Hole", definition: "Collapsed core of a massive star; gravity so strong that light cannot escape.", difficulty: "hard" },
            { id: 51, term: "Black Hole Gravity", definition: "Gravitational force at the surface (event horizon) is so extreme that escape velocity exceeds the speed of light.", difficulty: "hard" },
            { id: 52, term: "Evidence for Black Holes", definition: "Detected by observing effects on nearby matter: X-rays from accretion disks, gravitational effects on stars, gravitational waves from mergers.", difficulty: "hard" },

            // ASTRONOMY: GALAXIES
            { id: 53, term: "Spiral Galaxy", definition: "Disk-shaped galaxies with spiral arms, active star formation, and gas/dust (e.g., Milky Way, Andromeda).", difficulty: "medium" },
            { id: 54, term: "Elliptical Galaxy", definition: "Round/oval galaxies with mostly old stars and little gas/dust; little to no star formation.", difficulty: "medium" },
            { id: 55, term: "Irregular Galaxy", definition: "Galaxies with no definite shape; often result from gravitational interactions or collisions.", difficulty: "medium" },
            { id: 56, term: "Our Galaxy (Milky Way)", definition: "Spiral galaxy containing our solar system; ~100,000 light-years across, Sun located in outer spiral arm.", difficulty: "medium" },

            // ASTRONOMY: EXPANSION OF UNIVERSE
            { id: 57, term: "Light-year", definition: "Distance light travels in one year (~9.46 trillion km); used to measure cosmic distances.", difficulty: "easy" },
            { id: 58, term: "Doppler Effect", definition: "Change in wave frequency/wavelength due to motion of source or observer; approaching = compressed waves, receding = stretched waves.", difficulty: "medium" },
            { id: 59, term: "Redshift / Blueshift", definition: "Redshift = longer wavelength (moving away). Blueshift = shorter wavelength (moving toward). Caused by Doppler effect.", difficulty: "medium" },
            { id: 60, term: "Hubble's Law", definition: "Galaxies recede at speeds proportional to their distance: v = H₀ × d. Shows universe is expanding.", difficulty: "hard" },

            // ASTRONOMY: BIG BANG
            { id: 61, term: "Big Bang Theory", definition: "The universe began ~13.8 billion years ago from an extremely hot, dense state and has been expanding and cooling ever since.", difficulty: "hard" },
            { id: 62, term: "Evidence for Big Bang", definition: "Three main pieces: 1) Hubble expansion, 2) Cosmic microwave background radiation, 3) Abundance of light elements (H, He, Li).", difficulty: "hard" },
            { id: 63, term: "Cosmic Microwave Background", definition: "Faint radiation from ~380,000 years after Big Bang; observed everywhere in sky as ~2.7K microwave glow.", difficulty: "hard" },
            { id: 64, term: "Abundance of Light Elements", definition: "Universe contains ~75% hydrogen, ~25% helium, trace lithium; matches predictions from Big Bang nucleosynthesis.", difficulty: "hard" }
          ];

          // ==========================
          //  APPLICATION QUESTIONS (Thinking-based)
          // ==========================
          const applicationQuestions = [
            // PHYSICS - Newton's Laws
            { id: "app1", question: "A car crashes into a wall and stops. The wall exerts 50,000 N of force on the car. According to Newton's Third Law, how much force does the car exert on the wall?", correctAnswer: "50,000 N in the opposite direction", distractors: ["25,000 N", "100,000 N", "0 N because the car stopped"], difficulty: "medium", topic: "Physics" },
            { id: "app2", question: "Two identical cars traveling at the same speed collide head-on. Car A has twice the mass of Car B. Which car experiences more force during the collision?", correctAnswer: "Both experience equal force (Newton's 3rd Law)", distractors: ["Car A experiences more force", "Car B experiences more force", "Neither experiences force"], difficulty: "hard", topic: "Physics" },
            { id: "app3", question: "If you double the distance you push a box with the same force, what happens to the work done?", correctAnswer: "Work doubles", distractors: ["Work stays the same", "Work is cut in half", "Work quadruples"], difficulty: "medium", topic: "Physics" },
            { id: "app4", question: "A planet orbits twice as far from the Sun as Earth. According to the inverse square law, how does the gravitational force compare to Earth's?", correctAnswer: "1/4 as strong", distractors: ["1/2 as strong", "Twice as strong", "1/8 as strong"], difficulty: "hard", topic: "Physics" },
            { id: "app5", question: "Why does a heavy truck take longer to stop than a car traveling at the same speed?", correctAnswer: "Greater momentum requires more impulse (force × time) to stop", distractors: ["The truck has more friction", "The truck has less kinetic energy", "The truck experiences less force from brakes"], difficulty: "hard", topic: "Physics" },

            // EARTH SCIENCE - Oceans & Atmosphere
            { id: "app6", question: "Why are ocean tides higher during a new moon or full moon?", correctAnswer: "Sun and Moon align, combining their gravitational pull", distractors: ["Moon is closer to Earth", "Ocean water is warmer", "Earth's rotation speeds up"], difficulty: "medium", topic: "Earth Science" },
            { id: "app7", question: "Most meteors burn up in which atmospheric layer and why?", correctAnswer: "Mesosphere - because air friction creates intense heat", distractors: ["Thermosphere - highest temperature", "Stratosphere - ozone layer", "Troposphere - densest air"], difficulty: "hard", topic: "Earth Science" },
            { id: "app8", question: "Why is it warmer in summer than winter (for locations not at the equator)?", correctAnswer: "Earth's tilt causes more direct sunlight and longer days", distractors: ["Earth is closer to the Sun", "The atmosphere is thinner", "More greenhouse gases in summer"], difficulty: "medium", topic: "Earth Science" },
            { id: "app9", question: "A city on the coast has milder temperatures year-round compared to an inland city at the same latitude. Why?", correctAnswer: "Ocean water has high heat capacity, moderating temperatures", distractors: ["Coastal cities have more clouds", "Ocean salinity affects air temperature", "Sea level is lower than inland"], difficulty: "hard", topic: "Earth Science" },
            { id: "app10", question: "What would happen to Earth's climate if greenhouse gas concentrations suddenly doubled?", correctAnswer: "More terrestrial radiation trapped, global temperatures rise", distractors: ["Solar radiation would decrease", "More solar radiation would reach Earth", "Seasons would reverse"], difficulty: "hard", topic: "Earth Science" },

            // EARTH SCIENCE - Weather & Climate
            { id: "app11", question: "Why do hurricanes lose strength when they move over land?", correctAnswer: "Cut off from warm ocean water (energy source)", distractors: ["Land friction slows rotation", "Temperature drops too quickly", "Mountains block the storm"], difficulty: "medium", topic: "Earth Science" },
            { id: "app12", question: "Air rises over a mountain, cools, and forms clouds on the windward side. What happens on the leeward (downwind) side?", correctAnswer: "Air descends, warms, becomes dry (rain shadow)", distractors: ["More clouds form", "Temperature stays the same", "Air becomes more humid"], difficulty: "hard", topic: "Earth Science" },
            { id: "app13", question: "The dew point is 15°C and the air temperature is 25°C. Will condensation occur?", correctAnswer: "No - air must cool to dew point first", distractors: ["Yes - condensation always occurs", "Only if humidity increases", "Only at night"], difficulty: "medium", topic: "Earth Science" },
            { id: "app14", question: "Why do tornadoes most commonly form in 'Tornado Alley' (central United States)?", correctAnswer: "Cold dry air from Canada meets warm moist air from Gulf, creating wind shear", distractors: ["Mountains create wind tunnels", "Flat land has no obstacles", "Magnetic fields are stronger"], difficulty: "hard", topic: "Earth Science" },

            // ASTRONOMY - Solar System
            { id: "app15", question: "Why do inner planets orbit the Sun faster than outer planets?", correctAnswer: "Closer distance = stronger gravity = higher orbital speed (Kepler's laws)", distractors: ["Inner planets are smaller", "Inner planets are rockier", "Outer planets have more moons"], difficulty: "hard", topic: "Astronomy" },
            { id: "app16", question: "A comet's tail always points away from the Sun, even when moving away from the Sun. Why?", correctAnswer: "Solar wind and radiation pressure push material away", distractors: ["Comet's motion creates the tail direction", "Gravity pulls the tail", "Magnetic fields orient the tail"], difficulty: "hard", topic: "Astronomy" },
            { id: "app17", question: "Why is Pluto no longer classified as a planet?", correctAnswer: "Has not cleared its orbital path of other objects", distractors: ["Too small", "Orbit is too elliptical", "Too far from the Sun"], difficulty: "medium", topic: "Astronomy" },
            { id: "app18", question: "What's the main reason we see different phases of the Moon?", correctAnswer: "Changing angle between Sun, Moon, and Earth as Moon orbits", distractors: ["Earth's shadow on the Moon", "Moon's rotation", "Distance from Earth changes"], difficulty: "medium", topic: "Astronomy" },

            // ASTRONOMY - Stars & Galaxies
            { id: "app19", question: "Star A and Star B have the same temperature, but Star A appears brighter. What can you conclude?", correctAnswer: "Star A is either closer or has greater luminosity", distractors: ["Star A is hotter", "Star A is older", "Star A has more planets"], difficulty: "hard", topic: "Astronomy" },
            { id: "app20", question: "A blue star and a red star have the same luminosity. According to the H-R diagram, which is larger?", correctAnswer: "Red star - must be larger to output same energy at lower temperature", distractors: ["Blue star", "Same size", "Cannot determine from this information"], difficulty: "hard", topic: "Astronomy" },
            { id: "app21", question: "Why don't we see the same constellations year-round?", correctAnswer: "Earth's revolution around Sun changes our nighttime view of space", distractors: ["Stars move in the galaxy", "Earth's rotation changes", "Atmospheric conditions vary"], difficulty: "medium", topic: "Astronomy" },
            { id: "app22", question: "What determines whether a star becomes a white dwarf or a black hole after death?", correctAnswer: "Initial mass - low/medium mass → white dwarf; high mass → black hole", distractors: ["Temperature during life", "Distance from galactic center", "Chemical composition"], difficulty: "hard", topic: "Astronomy" },
            { id: "app23", question: "Why do spiral galaxies have more new star formation than elliptical galaxies?", correctAnswer: "Spiral galaxies have more gas and dust for star formation", distractors: ["Spiral galaxies are younger", "Elliptical galaxies rotate faster", "Gravity is stronger in spiral galaxies"], difficulty: "hard", topic: "Astronomy" },

            // ASTRONOMY - Expansion & Big Bang
            { id: "app24", question: "Galaxy A is 2 times farther from us than Galaxy B. According to Hubble's Law, how do their recession speeds compare?", correctAnswer: "Galaxy A recedes 2 times faster", distractors: ["Galaxy A recedes 4 times faster", "Same recession speed", "Galaxy A recedes half as fast"], difficulty: "hard", topic: "Astronomy" },
            { id: "app25", question: "An astronomer observes a galaxy with strong redshift. What does this tell us?", correctAnswer: "The galaxy is moving away from us rapidly", distractors: ["The galaxy is very hot", "The galaxy is moving toward us", "The galaxy is very old"], difficulty: "medium", topic: "Astronomy" },
            { id: "app26", question: "Why is the cosmic microwave background important evidence for the Big Bang?", correctAnswer: "It's leftover radiation from when the universe was hot and dense", distractors: ["It shows the universe is still expanding", "It proves dark matter exists", "It measures the age of stars"], difficulty: "hard", topic: "Astronomy" },
            { id: "app27", question: "If the Big Bang theory is correct, why is hydrogen the most abundant element in the universe?", correctAnswer: "Hydrogen formed first in Big Bang nucleosynthesis as the simplest element", distractors: ["Hydrogen is produced by all stars", "Hydrogen lasts longer than other elements", "Hydrogen is created by black holes"], difficulty: "hard", topic: "Astronomy" },

            // MIXED CONCEPTS
            { id: "app28", question: "During a solar eclipse, what type of eclipse does the Moon experience from its perspective?", correctAnswer: "Lunar eclipse (Earth blocks sunlight from Moon's view)", distractors: ["Solar eclipse", "No eclipse occurs", "Partial eclipse only"], difficulty: "hard", topic: "Astronomy" },
            { id: "app29", question: "Why can we detect black holes if light cannot escape them?", correctAnswer: "We observe their effects: X-rays from accretion disks, stellar orbits, gravitational waves", distractors: ["They emit radio waves", "They reflect nearby starlight", "They glow from heat"], difficulty: "hard", topic: "Astronomy" },
            { id: "app30", question: "If convection stopped in Earth's atmosphere, what would happen to weather patterns?", correctAnswer: "Weather would cease - no vertical air movement, no clouds, no storms", distractors: ["Weather would become more severe", "Only ocean weather would change", "Seasons would disappear"], difficulty: "hard", topic: "Earth Science" }
          ];

          // ==========================
          //  LOCAL STORAGE PROGRESS
          // ==========================
          const STORAGE_KEY = "studyBuddyMajorConceptsProgress_v1";

          function loadProgress() {
            try {
              const raw = localStorage.getItem(STORAGE_KEY);
              if (!raw) return {};
              return JSON.parse(raw) || {};
            } catch {
              return {};
            }
          }

          function saveProgress() {
            try {
              localStorage.setItem(STORAGE_KEY, JSON.stringify(progress));
            } catch {
              /* ignore */
            }
          }

          const progress = loadProgress();

          function getCardStatus(id) {
            if (progress[id] && progress[id].status === "known") return "known";
            return "unknown";
          }

          function setCardStatus(id, status) {
            progress[id] = { status };
            saveProgress();
            updateActiveDeck();
          }

          // ==========================
          //  FILTERING
          // ==========================
          let currentFilter = "all";
          let currentDifficulty = "all";

          const filterButtons = document.querySelectorAll(".filter-button[data-filter]");
          filterButtons.forEach((btn) => {
            btn.addEventListener("click", () => {
              currentFilter = btn.dataset.filter;
              filterButtons.forEach((b) =>
                b.classList.toggle("filter-active", b === btn)
              );
              updateActiveDeck();
              initQuizDeck(false);
              buildMatchingRound();
              renderCard();
            });
          });

          const difficultyButtons = document.querySelectorAll(".filter-button[data-difficulty]");
          difficultyButtons.forEach((btn) => {
            btn.addEventListener("click", () => {
              currentDifficulty = btn.dataset.difficulty;
              difficultyButtons.forEach((b) =>
                b.classList.toggle("filter-active", b === btn)
              );
              updateActiveDeck();
              initQuizDeck(false);
              buildMatchingRound();
              renderCard();
            });
          });

          function getActiveDeck() {
            let deck = flashcards.slice();

            // Apply status filter
            if (currentFilter !== "all") {
              deck = deck.filter((card) => getCardStatus(card.id) === currentFilter);
            }

            // Apply difficulty filter
            if (currentDifficulty !== "all") {
              deck = deck.filter((card) => card.difficulty === currentDifficulty);
            }

            return deck;
          }

          let activeDeck = getActiveDeck();

          function updateActiveDeck() {
            activeDeck = getActiveDeck();
            const deckCountEl = document.getElementById("deck-count");
            deckCountEl.textContent =
              activeDeck.length === 0
                ? flashcards.length + " (no cards match filter)"
                : activeDeck.length;
          }

          // ==========================
          //  MODE SWITCHING
          // ==========================
          const modes = {
            flashcards: document.getElementById("mode-flashcards"),
            matching: document.getElementById("mode-matching"),
            quiz: document.getElementById("mode-quiz"),
          };

          const modeButtons = document.querySelectorAll(".mode-button");
          let currentMode = "flashcards";

          function switchMode(modeName) {
            currentMode = modeName;

            Object.entries(modes).forEach(([name, el]) => {
              el.classList.toggle("hidden", name !== modeName);
            });

            modeButtons.forEach((btn) => {
              btn.classList.toggle("mode-active", btn.dataset.mode === modeName);
            });

            if (modeName === "matching") buildMatchingRound();
            if (modeName === "quiz") initQuizQuestion();
            if (modeName === "flashcards") renderCard();
          }

          modeButtons.forEach((btn) => {
            btn.addEventListener("click", () => switchMode(btn.dataset.mode));
          });

          // ==========================
          //  FLASHCARDS LOGIC
          // ==========================
          let currentIndex = 0;
          let showingTerm = true;
          let knownCount = 0;
          let unknownCount = 0;
          let reviewedCount = 0;

          const cardEl = document.getElementById("flashcard");
          const cardLabel = document.getElementById("card-label");
          const cardContent = document.getElementById("card-content");
          const cardHint = document.getElementById("card-hint");
          const statsDiv = document.getElementById("stats");

          function renderCard() {
            if (activeDeck.length === 0) {
              cardLabel.textContent = "No cards";
              cardContent.textContent =
                currentFilter === "known"
                  ? "You haven’t marked any cards as Got it yet."
                  : "You haven’t marked any cards as Not yet yet.";
              cardHint.textContent = "Switch filter or study in All cards mode.";
              statsDiv.textContent = "";
              return;
            }

            if (currentIndex >= activeDeck.length) currentIndex = 0;

            const card = activeDeck[currentIndex];
            if (showingTerm) {
              cardLabel.textContent = "Term";
              cardContent.textContent = card.term;
              cardHint.textContent = "Click or press Space to see the definition.";
            } else {
              cardLabel.textContent = "Definition";
              cardContent.textContent = card.definition;
              cardHint.textContent = "Click or press Space to go back to the term.";
            }
            updateFlashcardStats();
          }

          function updateFlashcardStats() {
            statsDiv.innerHTML =
              "<span>Card " +
              (activeDeck.length === 0 ? 0 : currentIndex + 1) +
              " / " +
              activeDeck.length +
              "</span>" +
              "<span>Reviewed this session: " +
              reviewedCount +
              "</span>" +
              "<span>Got it: " +
              knownCount +
              "</span>" +
              "<span>Not yet: " +
              unknownCount +
              "</span>";
          }

          function nextCard() {
            if (!activeDeck.length) return;
            currentIndex = (currentIndex + 1) % activeDeck.length;
            showingTerm = true;
            renderCard();
          }

          function prevCard() {
            if (!activeDeck.length) return;
            currentIndex = (currentIndex - 1 + activeDeck.length) % activeDeck.length;
            showingTerm = true;
            renderCard();
          }

          function flipCard() {
            if (!activeDeck.length) return;
            showingTerm = !showingTerm;
            renderCard();
          }

          function shuffleCards() {
            if (!activeDeck.length) return;
            for (let i = activeDeck.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [activeDeck[i], activeDeck[j]] = [activeDeck[j], activeDeck[i]];
            }
            currentIndex = 0;
            showingTerm = true;
            renderCard();
          }

          function markKnown() {
            if (!activeDeck.length) return;
            const card = activeDeck[currentIndex];
            setCardStatus(card.id, "known");
            knownCount++;
            reviewedCount++;
            updateActiveDeck();
            activeDeck = getActiveDeck();
            if (currentFilter === "unknown" && currentIndex >= activeDeck.length) {
              currentIndex = 0;
            }
            nextCard();
          }

          function markUnknown() {
            if (!activeDeck.length) return;
            const card = activeDeck[currentIndex];
            setCardStatus(card.id, "unknown");
            unknownCount++;
            reviewedCount++;
            updateActiveDeck();
            activeDeck = getActiveDeck();
            if (currentFilter === "known" && currentIndex >= activeDeck.length) {
              currentIndex = 0;
            }
            nextCard();
          }

          function resetFlashStats() {
            knownCount = 0;
            unknownCount = 0;
            reviewedCount = 0;
            updateFlashcardStats();
          }

          document.getElementById("next").addEventListener("click", nextCard);
          document.getElementById("prev").addEventListener("click", prevCard);
          document.getElementById("flip").addEventListener("click", flipCard);
          document.getElementById("shuffle").addEventListener("click", shuffleCards);
          document.getElementById("know").addEventListener("click", markKnown);
          document.getElementById("dontKnow").addEventListener("click", markUnknown);
          document.getElementById("reset").addEventListener("click", resetFlashStats);
          cardEl.addEventListener("click", flipCard);

          document.addEventListener("keydown", (e) => {
            if (currentMode !== "flashcards") return;
            if (e.code === "ArrowRight") nextCard();
            else if (e.code === "ArrowLeft") prevCard();
            else if (e.code === "Space") {
              e.preventDefault();
              flipCard();
            } else if (e.key === "1") markKnown();
            else if (e.key === "2") markUnknown();
          });

          // ==========================
          //  MATCHING MODE
          // ==========================
          const matchingContainer = document.getElementById("matching-container");
          const matchingResult = document.getElementById("matching-result");
          const matchingNewBtn = document.getElementById("matching-new");
          const matchingCheckBtn = document.getElementById("matching-check");

          function getRandomSample(arr, count) {
            const copy = arr.slice();
            const result = [];
            const target = Math.min(count, copy.length);
            for (let i = 0; i < target; i++) {
              const idx = Math.floor(Math.random() * copy.length);
              result.push(copy.splice(idx, 1)[0]);
            }
            return result;
          }

          function buildMatchingRound() {
            matchingContainer.innerHTML = "";
            matchingResult.textContent = "";

            let deck = getActiveDeck();
            if (deck.length < 3) deck = flashcards.slice();

            const roundCards = getRandomSample(deck, 6);
            const definitions = roundCards.map((c) => c.definition);

            for (let i = definitions.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [definitions[i], definitions[j]] = [definitions[j], definitions[i]];
            }

            roundCards.forEach((card) => {
              const row = document.createElement("div");
              row.className = "matching-row";

              const termDiv = document.createElement("div");
              termDiv.className = "matching-term";
              termDiv.textContent = card.term;
              row.appendChild(termDiv);

              const select = document.createElement("select");
              select.className = "matching-select";
              select.dataset.correctDefinition = card.definition;

              const placeholder = document.createElement("option");
              placeholder.value = "";
              placeholder.textContent = "Select definition…";
              placeholder.disabled = true;
              placeholder.selected = true;
              select.appendChild(placeholder);

              definitions.forEach((def) => {
                const opt = document.createElement("option");
                opt.value = def;
                opt.textContent = def.length > 120 ? def.slice(0, 120) + "…" : def;
                select.appendChild(opt);
              });

              row.appendChild(select);
              matchingContainer.appendChild(row);
            });
          }

          function checkMatchingAnswers() {
            const selects = matchingContainer.querySelectorAll("select");
            if (!selects.length) return;

            let correct = 0;
            const total = selects.length;

            selects.forEach((sel) => {
              sel.classList.remove("correct", "incorrect");
              if (!sel.value) return;
              if (sel.value === sel.dataset.correctDefinition) {
                correct++;
                sel.classList.add("correct");
              } else {
                sel.classList.add("incorrect");
              }
            });

            matchingResult.textContent = "You matched " + correct + " out of " + total + ".";
          }

          matchingNewBtn.addEventListener("click", buildMatchingRound);
          matchingCheckBtn.addEventListener("click", checkMatchingAnswers);

          // ==========================
          //  QUIZ MODE
          // ==========================
          const quizQuestionEl = document.getElementById("quiz-question");
          const quizOptionsEl = document.getElementById("quiz-options");
          const quizFeedbackEl = document.getElementById("quiz-feedback");
          const quizStatsEl = document.getElementById("quiz-stats");
          const quizNextBtn = document.getElementById("quiz-next");
          const quizResetBtn = document.getElementById("quiz-reset");
          const quizRetryBtn = document.getElementById("quiz-retry");
          const quizRoundLabel = document.getElementById("quiz-round-label");
          const quizNewSessionBtn = document.getElementById("quiz-new-session");
          const quizTimerDisplay = document.getElementById("quiz-timer-display");
          const quizProgressFill = document.getElementById("quiz-progress-fill");
          const quizExplanation = document.getElementById("quiz-explanation");
          const quizSummary = document.getElementById("quiz-summary");

          // Quiz settings controls
          const quizAppOnlyCheckbox = document.getElementById("quiz-app-only");
          const quizTimerCheckbox = document.getElementById("quiz-timer");
          const quizDifficultySelect = document.getElementById("quiz-difficulty-select");
          const quizQuestionCountSelect = document.getElementById("quiz-question-count");

          let quizCorrect = 0;
          let quizTotal = 0;
          let currentQuizAnswer = null;
          let quizAnswered = false;

          let quizDeck = [];
          let quizIndex = 0;

          let missedIds = [];
          let retryMode = false;
          let useApplicationQuestions = false; // Mix in harder questions

          // Enhanced quiz settings
          let quizSettings = {
            applicationOnly: false,
            timerEnabled: false,
            difficulty: 'all',
            questionCount: 20,
            timerSeconds: 30
          };
          let quizTimer = null;
          let timeRemaining = 30;
          let quizSessionStats = {
            totalQuestions: 0,
            correctAnswers: 0,
            incorrectAnswers: 0,
            averageTime: 0,
            streak: 0,
            bestStreak: 0,
            questionTimes: []
          };
          let questionStartTime = 0;

          function shuffleArray(arr) {
            const copy = arr.slice();
            for (let i = copy.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [copy[i], copy[j]] = [copy[j], copy[i]];
            }
            return copy;
          }

          function initQuizDeck(fromMissed) {
            let deckSource;
            if (fromMissed && missedIds.length > 0) {
              deckSource = flashcards.filter((c) => missedIds.includes(c.id));
            } else {
              let deck = getActiveDeck();

              // Apply quiz difficulty filter (separate from global difficulty)
              if (quizSettings.difficulty !== 'all' && quizSettings.difficulty !== 'progressive') {
                deck = deck.filter(c => c.difficulty === quizSettings.difficulty);
              }

              if (deck.length < 4) deck = flashcards.slice();

              // Apply question count limit
              const maxQuestions = quizSettings.questionCount === 'all'
                ? deck.length
                : parseInt(quizSettings.questionCount);

              deckSource = deck.slice(0, maxQuestions);
            }

            // Progressive difficulty: sort by difficulty
            if (quizSettings.difficulty === 'progressive') {
              const diffOrder = { easy: 1, medium: 2, hard: 3 };
              deckSource.sort((a, b) => diffOrder[a.difficulty] - diffOrder[b.difficulty]);
              quizDeck = deckSource.map((c) => c.id);
            } else {
              quizDeck = shuffleArray(deckSource.map((c) => c.id));
            }

            quizIndex = 0;
            updateProgressBar();
          }

          function getCardById(id) {
            return flashcards.find((c) => c.id === id);
          }

          function initQuizQuestion() {
            if (quizDeck.length === 0) initQuizDeck(retryMode);

            if (quizDeck.length === 0) {
              quizQuestionEl.textContent = "No cards available for quiz.";
              quizOptionsEl.innerHTML = "";
              quizFeedbackEl.textContent = "";
              quizExplanation.classList.remove("show");
              return;
            }

            // Check if quiz session is complete
            if (quizIndex >= quizDeck.length && !retryMode) {
              showQuizSummary();
              return;
            }

            quizFeedbackEl.textContent = "";
            quizFeedbackEl.className = "quiz-feedback";
            quizExplanation.classList.remove("show");
            quizAnswered = false;
            questionStartTime = Date.now();

            if (quizIndex >= quizDeck.length) initQuizDeck(retryMode);

            // Determine if we should use application question
            const useAppQuestion = quizSettings.applicationOnly ||
                                  (Math.random() < 0.4 && applicationQuestions.length > 0 && !quizSettings.applicationOnly);

            if (useAppQuestion && (quizSettings.applicationOnly || applicationQuestions.length > 0)) {
              // Application question
              let appQ;
              if (quizSettings.difficulty !== 'all' && quizSettings.difficulty !== 'progressive') {
                const filteredAppQ = applicationQuestions.filter(q => q.difficulty === quizSettings.difficulty);
                appQ = filteredAppQ.length > 0
                  ? filteredAppQ[Math.floor(Math.random() * filteredAppQ.length)]
                  : applicationQuestions[Math.floor(Math.random() * applicationQuestions.length)];
              } else {
                appQ = applicationQuestions[Math.floor(Math.random() * applicationQuestions.length)];
              }

              currentQuizAnswer = appQ.correctAnswer;

              quizQuestionEl.innerHTML = "<strong>🧠 APPLICATION:</strong> " + appQ.question;
              quizRoundLabel.textContent = retryMode ? "Retry – missed questions" : "Question " + (quizIndex + 1) + " of " + quizDeck.length;

              const choices = shuffleArray([appQ.correctAnswer, ...appQ.distractors]);

              quizOptionsEl.innerHTML = "";
              choices.forEach((choice) => {
                const btn = document.createElement("button");
                btn.className = "quiz-option";
                btn.textContent = choice;
                btn.addEventListener("click", () => handleQuizAnswer(btn, choice, true, appQ));
                quizOptionsEl.appendChild(btn);
              });
            } else {
              // Regular flashcard question
              const cardId = quizDeck[quizIndex];
              const card = getCardById(cardId);
              currentQuizAnswer = card.term;

              quizQuestionEl.textContent = card.definition;
              quizRoundLabel.textContent = retryMode
                ? "Retry – missed questions"
                : "Question " + (quizIndex + 1) + " of " + quizDeck.length;

              let pool = flashcards.filter((c) => c.id !== cardId);
              pool = shuffleArray(pool);
              const distractors = pool.slice(0, 3).map((c) => c.term);
              const choices = shuffleArray([currentQuizAnswer, ...distractors]);

              quizOptionsEl.innerHTML = "";
              choices.forEach((choice) => {
                const btn = document.createElement("button");
                btn.className = "quiz-option";
                btn.textContent = choice;
                btn.addEventListener("click", () => handleQuizAnswer(btn, choice, false, card));
                quizOptionsEl.appendChild(btn);
              });
            }

            updateQuizStats();
            updateProgressBar();

            // Start timer if enabled
            if (quizSettings.timerEnabled) {
              startQuizTimer();
            } else {
              quizTimerDisplay.textContent = "";
            }
          }

          function handleQuizAnswer(button, choice, isAppQuestion, questionData) {
            if (quizAnswered) return;
            quizAnswered = true;
            quizTotal++;

            // Stop timer
            if (quizTimer) {
              clearInterval(quizTimer);
              quizTimer = null;
            }

            // Calculate time taken
            const timeTaken = (Date.now() - questionStartTime) / 1000;
            quizSessionStats.questionTimes.push(timeTaken);

            const optionButtons = quizOptionsEl.querySelectorAll("button");
            optionButtons.forEach((btn) => {
              btn.disabled = true;
              if (btn.textContent === currentQuizAnswer) btn.classList.add("correct");
            });

            const isCorrect = choice === currentQuizAnswer;

            if (isCorrect) {
              quizCorrect++;
              quizSessionStats.correctAnswers++;
              quizSessionStats.streak++;
              if (quizSessionStats.streak > quizSessionStats.bestStreak) {
                quizSessionStats.bestStreak = quizSessionStats.streak;
              }

              quizFeedbackEl.textContent = isAppQuestion
                ? "🎯 Excellent reasoning! ✅"
                : "✅ Correct! (" + timeTaken.toFixed(1) + "s)";
              quizFeedbackEl.classList.add("correct");

              if (!isAppQuestion && retryMode) {
                const currentId = quizDeck[quizIndex];
                missedIds = missedIds.filter((id) => id !== currentId);
              }
            } else {
              quizSessionStats.incorrectAnswers++;
              quizSessionStats.streak = 0;

              quizFeedbackEl.textContent = "❌ Not quite. Correct answer: " + currentQuizAnswer;
              quizFeedbackEl.classList.add("incorrect");
              button.classList.add("incorrect");

              if (!isAppQuestion) {
                const currentId = quizDeck[quizIndex];
                if (!missedIds.includes(currentId)) missedIds.push(currentId);
              }

              // Show explanation for incorrect answers
              showExplanation(questionData, isAppQuestion);
            }

            quizSessionStats.totalQuestions++;
            if (!isAppQuestion) quizIndex++;
            updateQuizStats();
            updateProgressBar();
          }

          function showExplanation(questionData, isAppQuestion) {
            if (!questionData) return;

            let explanationText = "";

            if (isAppQuestion) {
              // For application questions, provide context
              explanationText = "💡 This question tests your understanding of " + questionData.topic + ". ";
              explanationText += "The correct answer requires applying concepts, not just memorization.";
            } else {
              // For regular flashcards, show the full definition
              explanationText = "📖 Definition: " + questionData.definition;
            }

            quizExplanation.textContent = explanationText;
            quizExplanation.classList.add("show");
          }

          function updateQuizStats() {
            const pct = quizTotal === 0 ? 0 : Math.round((quizCorrect / quizTotal) * 100);
            const missedCount = missedIds.length;
            const streak = quizSessionStats.streak;
            const avgTime = quizSessionStats.questionTimes.length > 0
              ? (quizSessionStats.questionTimes.reduce((a, b) => a + b, 0) / quizSessionStats.questionTimes.length).toFixed(1)
              : 0;

            quizStatsEl.innerHTML =
              "<span>Score: " + quizCorrect + "/" + quizTotal + " (" + pct + "%)</span>" +
              "<span>Streak: " + streak + " 🔥</span>" +
              "<span>Best: " + quizSessionStats.bestStreak + "</span>" +
              "<span>Avg time: " + avgTime + "s</span>" +
              "<span>Missed: " + missedCount + "</span>";
          }

          function updateProgressBar() {
            if (quizDeck.length === 0) return;
            const progress = (quizIndex / quizDeck.length) * 100;
            quizProgressFill.style.width = progress + "%";
          }

          function startQuizTimer() {
            if (quizTimer) clearInterval(quizTimer);

            timeRemaining = quizSettings.timerSeconds;
            updateTimerDisplay();

            quizTimer = setInterval(() => {
              timeRemaining--;
              updateTimerDisplay();

              if (timeRemaining <= 0) {
                clearInterval(quizTimer);
                quizTimer = null;
                // Auto-submit as incorrect
                if (!quizAnswered) {
                  const optionButtons = quizOptionsEl.querySelectorAll("button");
                  if (optionButtons.length > 0) {
                    handleQuizAnswer(optionButtons[0], "", false, null);
                    quizFeedbackEl.textContent = "⏱️ Time's up!";
                  }
                }
              }
            }, 1000);
          }

          function updateTimerDisplay() {
            quizTimerDisplay.textContent = "⏱️ " + timeRemaining + "s";
            quizTimerDisplay.classList.remove("warning", "danger");

            if (timeRemaining <= 5) {
              quizTimerDisplay.classList.add("danger");
            } else if (timeRemaining <= 10) {
              quizTimerDisplay.classList.add("warning");
            }
          }

          function showQuizSummary() {
            const totalTime = quizSessionStats.questionTimes.reduce((a, b) => a + b, 0);
            const avgTime = (totalTime / quizSessionStats.questionTimes.length).toFixed(1);
            const pct = Math.round((quizSessionStats.correctAnswers / quizSessionStats.totalQuestions) * 100);

            let grade = "";
            if (pct >= 90) grade = "🏆 Outstanding!";
            else if (pct >= 80) grade = "🌟 Excellent!";
            else if (pct >= 70) grade = "👍 Good job!";
            else if (pct >= 60) grade = "📚 Keep studying!";
            else grade = "💪 Review needed!";

            quizSummary.innerHTML = `
              <h3>📊 Quiz Session Complete! ${grade}</h3>
              <div class="quiz-summary-grid">
                <div class="quiz-summary-stat">
                  <div class="quiz-summary-stat-value">${pct}%</div>
                  <div class="quiz-summary-stat-label">Score</div>
                </div>
                <div class="quiz-summary-stat">
                  <div class="quiz-summary-stat-value">${quizSessionStats.correctAnswers}</div>
                  <div class="quiz-summary-stat-label">Correct</div>
                </div>
                <div class="quiz-summary-stat">
                  <div class="quiz-summary-stat-value">${quizSessionStats.incorrectAnswers}</div>
                  <div class="quiz-summary-stat-label">Incorrect</div>
                </div>
                <div class="quiz-summary-stat">
                  <div class="quiz-summary-stat-value">${quizSessionStats.bestStreak}</div>
                  <div class="quiz-summary-stat-label">Best Streak</div>
                </div>
                <div class="quiz-summary-stat">
                  <div class="quiz-summary-stat-value">${avgTime}s</div>
                  <div class="quiz-summary-stat-label">Avg Time</div>
                </div>
                <div class="quiz-summary-stat">
                  <div class="quiz-summary-stat-value">${missedIds.length}</div>
                  <div class="quiz-summary-stat-label">To Review</div>
                </div>
              </div>
            `;
            quizSummary.classList.add("show");

            quizQuestionEl.textContent = "Session complete! Start a new quiz or retry missed questions.";
            quizOptionsEl.innerHTML = "";
          }

          quizNextBtn.addEventListener("click", initQuizQuestion);

          quizResetBtn.addEventListener("click", () => {
            quizCorrect = 0;
            quizTotal = 0;
            missedIds = [];
            retryMode = false;
            initQuizDeck(false);
            updateQuizStats();
            initQuizQuestion();
          });

          quizRetryBtn.addEventListener("click", () => {
            if (missedIds.length === 0) {
              quizFeedbackEl.textContent = "No missed questions yet — keep going!";
              quizFeedbackEl.className = "quiz-feedback";
              return;
            }
            quizCorrect = 0;
            quizTotal = 0;
            retryMode = true;
            quizSummary.classList.remove("show");
            initQuizDeck(true);
            updateQuizStats();
            initQuizQuestion();
          });

          quizNewSessionBtn.addEventListener("click", () => {
            quizCorrect = 0;
            quizTotal = 0;
            missedIds = [];
            retryMode = false;
            quizSummary.classList.remove("show");
            quizSessionStats = {
              totalQuestions: 0,
              correctAnswers: 0,
              incorrectAnswers: 0,
              averageTime: 0,
              streak: 0,
              bestStreak: 0,
              questionTimes: []
            };
            initQuizDeck(false);
            updateQuizStats();
            initQuizQuestion();
          });

          // Quiz settings event listeners
          quizAppOnlyCheckbox.addEventListener("change", (e) => {
            quizSettings.applicationOnly = e.target.checked;
          });

          quizTimerCheckbox.addEventListener("change", (e) => {
            quizSettings.timerEnabled = e.target.checked;
            if (!e.target.checked && quizTimer) {
              clearInterval(quizTimer);
              quizTimer = null;
              quizTimerDisplay.textContent = "";
            }
          });

          quizDifficultySelect.addEventListener("change", (e) => {
            quizSettings.difficulty = e.target.value;
          });

          quizQuestionCountSelect.addEventListener("change", (e) => {
            quizSettings.questionCount = e.target.value;
          });

          // ==========================
          //  INITIALIZE
          // ==========================
          updateActiveDeck();
          renderCard();
          buildMatchingRound();
          initQuizDeck(false);
          initQuizQuestion();
        })();
      });
    </script>
  </body>
</html>
